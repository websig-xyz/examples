'use client'

import { useState, useEffect, useCallback } from 'react'

// Extended dialog interface for storing event handlers
interface DialogWithHandlers extends HTMLDialogElement {
  _inertObserver?: MutationObserver
  _onEscape?: (event: KeyboardEvent) => void
  _onBlur?: () => void
}

export default function Home() {
  const [walletStatus, setWalletStatus] = useState<'disconnected' | 'connecting' | 'connected'>('disconnected')
  const [walletAddress, setWalletAddress] = useState<string>('')
  const [iframeReady, setIframeReady] = useState(false)
  const [logs, setLogs] = useState<string[]>([])
  
  // Production configuration for LiquidRoute
  // When deployed to app.liquidroute.com, this will use production WebSig
  const WEBSIG_URL = process.env.NEXT_PUBLIC_WEBSIG_URL || 'https://websig.xyz'
  const APP_NAME = process.env.NEXT_PUBLIC_APP_NAME || 'LiquidRoute'
  const APP_ORIGIN = typeof window !== 'undefined' ? window.location.origin : (process.env.NEXT_PUBLIC_APP_URL || 'https://app.liquidroute.com')

  const addLog = (message: string) => {
    const timestamp = new Date().toLocaleTimeString()
    setLogs(prev => [...prev, `[${timestamp}] ${message}`])
    console.log(`[WebSig Example] ${message}`)
  }

  // Porto's exact implementation - store these as module-level variables
  const showIframe = useCallback(() => {
    addLog('Page loaded, initializing WebSig iframe integration')
    
    // Setup message handler for iframe communication (Porto-style)
    const handleMessage = (event: MessageEvent) => {
      // Only accept messages from WebSig
      if (event.origin !== WEBSIG_URL) {
        addLog(`Ignoring message from untrusted origin: ${event.origin}`)
        return
      }

      addLog(`Received message: ${JSON.stringify(event.data)}`)

      // Porto-style messages use topic/payload format
      const { topic, payload } = event.data

      if (topic === 'websig:connected') {
        setIframeReady(true)
        setWalletAddress(payload.publicKey)
        setWalletStatus('connected')
        addLog(`Wallet connected: ${payload.publicKey}`)
        hideIframe()
      } else if (topic === 'websig:rejected') {
        setWalletStatus('disconnected')
        addLog('User rejected connection')
        hideIframe()
      } else if (event.data.method === 'show-iframe') {
        showIframe() // Porto doesn't pass params
      } else if (event.data.method === 'hide-iframe') {
        hideIframe()
      }
    }

    window.addEventListener('message', handleMessage)
    return () => window.removeEventListener('message', handleMessage)
  }, [WEBSIG_URL, showIframe, hideIframe])

  // Porto's exact implementation - store these as module-level variables
  const showIframe = useCallback(() => {
    // These need to be inside the function to maintain state across calls
    const dialogState = (window as any).__dialogState || {
      dialogActive: false,
      visible: false,
      bodyStyle: null,
      opener: null
    };
    (window as any).__dialogState = dialogState
    // Porto's exact dialog creation
    let dialog = document.getElementById('websig-dialog') as HTMLDialogElement
    let iframe = document.getElementById('websig-iframe') as HTMLIFrameElement
    
    if (!dialog) {
      // Create dialog EXACTLY like Porto
      dialog = document.createElement('dialog')
      dialog.dataset.porto = ''
      dialog.id = 'websig-dialog'
      
      dialog.setAttribute('role', 'dialog')
      dialog.setAttribute('aria-closed', 'true')
      dialog.setAttribute('aria-label', 'Porto Wallet')
      dialog.setAttribute('hidden', 'until-found')
      
      // Porto's exact style
      Object.assign(dialog.style, {
        background: 'transparent',
        border: '0',
        outline: '0',
        padding: '0',
        position: 'fixed',
      })
      
      document.body.appendChild(dialog)
      
      // Create iframe EXACTLY like Porto if it doesn't exist
      if (!iframe) {
        iframe = document.createElement('iframe')
        iframe.id = 'websig-iframe'
        iframe.setAttribute('data-testid', 'porto')
        iframe.setAttribute('allow', `publickey-credentials-get ${WEBSIG_URL}; publickey-credentials-create ${WEBSIG_URL}; clipboard-write`)
        iframe.setAttribute('tabindex', '0')
        iframe.setAttribute('sandbox', 'allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox')
        iframe.setAttribute('src', `${WEBSIG_URL}/connect?origin=${encodeURIComponent(APP_ORIGIN)}&name=${encodeURIComponent(APP_NAME)}`)
        iframe.setAttribute('title', 'Porto')
        
        // Porto's exact iframe style
        Object.assign(iframe.style, {
          backgroundColor: 'transparent',
          border: '0',
          colorScheme: 'light dark',
          height: '100%',
          left: '0',
          position: 'fixed',
          top: '0',
          width: '100%',
        })
      }
      
      // Add Porto's exact CSS
      const style = document.createElement('style')
      style.innerHTML = `
        dialog[data-porto]::backdrop {
          background: transparent!important;
        }
      `
      
      dialog.appendChild(style)
      dialog.appendChild(iframe)
      
      // Porto's 1password workaround
      const inertObserver = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
          if (mutation.type !== 'attributes') continue
          const name = mutation.attributeName
          if (!name || name !== 'inert') continue
          dialog.removeAttribute(name)
        }
      })
      inertObserver.observe(dialog, {
        attributeOldValue: true,
        attributes: true,
      })
      
      // Porto's escape key handler
      const onEscape = (event: KeyboardEvent) => {
        if (event.key === 'Escape') hideIframe()
      }
      
      // Porto's click outside handler
      const onBlur = () => hideIframe()
      
      // Store these on the dialog for cleanup
      const dialogWithHandlers = dialog as DialogWithHandlers
      dialogWithHandlers._inertObserver = inertObserver
      dialogWithHandlers._onEscape = onEscape
      dialogWithHandlers._onBlur = onBlur
    }
    
    // Porto's exact showDialog function
    if (dialogState.visible) return
    dialogState.visible = true
    
    // Store the opener element to restore focus later (Porto)
    if (document.activeElement instanceof HTMLElement)
      dialogState.opener = document.activeElement
    
    dialog.removeAttribute('hidden')
    dialog.removeAttribute('aria-closed')
    dialog.showModal()
    
    // Porto's activateDialog function
    if (!dialogState.dialogActive) {
      dialogState.dialogActive = true
      
      const dialogWithHandlers = dialog as DialogWithHandlers
      if (dialogWithHandlers._onBlur) dialog.addEventListener('click', dialogWithHandlers._onBlur)
      if (dialogWithHandlers._onEscape) document.addEventListener('keydown', dialogWithHandlers._onEscape)
      iframe?.focus()
      dialog.style.pointerEvents = 'auto'
      
      dialogState.bodyStyle = Object.assign({}, document.body.style)
      document.body.style.overflow = 'hidden'
    }
    
    addLog('Dialog shown (Porto-style)')
  }, [WEBSIG_URL, APP_ORIGIN, APP_NAME])

  const hideIframe = useCallback(() => {
    const dialog = document.getElementById('websig-dialog') as HTMLDialogElement
    if (!dialog) return
    
    const dialogState = (window as any).__dialogState || {
      dialogActive: false,
      visible: false,
      bodyStyle: null,
      opener: null
    }
    
    // Porto's exact hideDialog function
    if (!dialogState.visible) return
    dialogState.visible = false
    
    dialog.setAttribute('hidden', 'true')
    dialog.setAttribute('aria-closed', 'true')
    dialog.close()
    
    // Porto's cleanup for 1password extension
    for (const sibling of dialog.parentNode ? Array.from(dialog.parentNode.children) : []) {
      if (sibling === dialog) continue
      if (!sibling.hasAttribute('inert')) continue
      sibling.removeAttribute('inert')
    }
    
    // Porto's activatePage function
    if (dialogState.dialogActive) {
      dialogState.dialogActive = false
      
      const dialogWithHandlers = dialog as DialogWithHandlers
      if (dialogWithHandlers._onBlur) dialog.removeEventListener('click', dialogWithHandlers._onBlur)
      if (dialogWithHandlers._onEscape) document.removeEventListener('keydown', dialogWithHandlers._onEscape)
      dialog.style.pointerEvents = 'none'
      dialogState.opener?.focus()
      dialogState.opener = null
      
      Object.assign(document.body.style, dialogState.bodyStyle ?? '')
      // Firefox: explicitly restore/clear overflow directly
      document.body.style.overflow = dialogState.bodyStyle?.overflow ?? ''
    }
    
    addLog('Dialog hidden (Porto-style)')
  }, [])

  const connectWallet = async () => {
    addLog('Connecting wallet...')
    setWalletStatus('connecting')

    const iframe = document.getElementById('websig-iframe') as HTMLIFrameElement
    if (!iframe || !iframe.contentWindow) {
      addLog('Error: iframe not found')
      return
    }

    // Porto approach: Just show the dialog
    showIframe()

    // Send connect message exactly like Porto does (with id, topic, payload)
    const messageId = crypto.randomUUID()
    iframe.contentWindow.postMessage(
      {
        id: messageId,
        topic: 'websig:connect',
        payload: {
          origin: window.location.origin,
          name: APP_NAME
        }
      },
      WEBSIG_URL // Target origin
    )
  }

  const signTransaction = async () => {
    addLog('Signing transaction...')
    
    const iframe = document.getElementById('websig-iframe') as HTMLIFrameElement
    if (!iframe || !iframe.contentWindow) {
      addLog('Error: iframe not found')
      return
    }

    // Porto approach: Just show the dialog
    showIframe()

    // Send transaction message exactly like Porto (with id)
    const messageId = crypto.randomUUID()
    iframe.contentWindow.postMessage(
      {
        id: messageId,
        topic: 'websig:signTransaction',
        payload: {
          transaction: 'mock_transaction_data'
        }
      },
      WEBSIG_URL
    )
  }

  return (
    <main className="min-h-screen bg-gradient-to-br from-gray-900 to-black text-white p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-4xl font-bold mb-2">LiquidRoute Wallet Integration</h1>
        <p className="text-gray-400 mb-8">Production cross-origin HTTPS integration with WebSig wallet</p>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          {/* Wallet Status */}
          <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
            <h2 className="text-xl font-semibold mb-4">Wallet Status</h2>
            <p className="text-xs text-gray-500 mb-2">
              {APP_ORIGIN} → {WEBSIG_URL}
            </p>
            
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <span className="text-gray-400">Status:</span>
                <span className={`font-mono ${
                  walletStatus === 'connected' ? 'text-green-400' :
                  walletStatus === 'connecting' ? 'text-yellow-400' :
                  'text-gray-500'
                }`}>
                  {walletStatus}
                </span>
              </div>

              <div className="flex items-center justify-between">
                <span className="text-gray-400">iframe Ready:</span>
                <span className={`font-mono ${iframeReady ? 'text-green-400' : 'text-gray-500'}`}>
                  {iframeReady ? 'Yes' : 'No'}
                </span>
              </div>

              {walletAddress && (
                <div className="flex items-center justify-between">
                  <span className="text-gray-400">Address:</span>
                  <span className="font-mono text-xs text-blue-400">
                    {walletAddress.slice(0, 8)}...{walletAddress.slice(-8)}
                  </span>
                </div>
              )}
            </div>

            <div className="mt-6 space-y-3">
              <button
                onClick={connectWallet}
                disabled={walletStatus === 'connected' || !iframeReady}
                className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-colors"
              >
                {walletStatus === 'connected' ? 'Connected' : 'Connect Wallet'}
              </button>

              <button
                onClick={signTransaction}
                disabled={walletStatus !== 'connected'}
                className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-colors"
              >
                Sign Transaction
              </button>
            </div>
          </div>

          {/* Integration Info */}
          <div className="bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
            <h2 className="text-xl font-semibold mb-4">Integration Details</h2>
            
            <div className="space-y-3 text-sm">
              <div className="p-3 bg-gray-900/50 rounded-lg">
                <p className="text-gray-400 mb-1">iframe Permissions:</p>
                <code className="text-green-400 text-xs">
                  publickey-credentials-get *<br/>
                  publickey-credentials-create *
                </code>
              </div>

              <div className="p-3 bg-gray-900/50 rounded-lg">
                <p className="text-gray-400 mb-1">WebSig Origin:</p>
                <code className="text-blue-400 text-xs">
                  http://localhost:3000
                </code>
              </div>

              <div className="p-3 bg-gray-900/50 rounded-lg">
                <p className="text-gray-400 mb-1">This App Origin:</p>
                <code className="text-blue-400 text-xs">
                  http://localhost:4000
                </code>
              </div>
            </div>
          </div>
        </div>

        {/* Console Logs */}
        <div className="mt-8 bg-gray-800/50 backdrop-blur rounded-xl p-6 border border-gray-700">
          <h2 className="text-xl font-semibold mb-4">Console</h2>
          <div className="bg-black/50 rounded-lg p-4 h-64 overflow-y-auto font-mono text-xs">
            {logs.length === 0 ? (
              <p className="text-gray-500">No logs yet...</p>
            ) : (
              logs.map((log, i) => (
                <div key={i} className="text-gray-300 mb-1">
                  {log}
                </div>
              ))
            )}
          </div>
        </div>
      </div>

      {/* Porto creates the iframe dynamically in the dialog - no iframe here */}
    </main>
  )
}